<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
      background: #f0f0f0;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      margin-top: 10px;
      cursor: pointer;
    }
    #points {
      font-size: 20px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>ğŸ® Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª</h1>
  <div id="message"></div>
  <button onclick="shareReferral()">Ø´Ø§Ø±Ùƒ Ø±Ø§Ø¨Ø·Ùƒ ÙˆØ§ÙƒØ³Ø¨ Ù†Ù‚Ø§Ø·!</button>
  <div id="points">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù‚Ø§Ø·...</div>

  <script>
    const supabaseUrl = 'https://fxhctxmcrbfcbmuxugih.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ4aGN0eG1jcmJmY2JtdXh1Z2loIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2ODI2NTQsImV4cCI6MjA3ODI1ODY1NH0.RuHOmehKZXzhxFa5pvlMXffh7J9kcZg0aTtnfQn-QLY'; // â† Ø¶Ø¹ Ø§Ù„Ù€ anon key Ù‡Ù†Ø§
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    function getTelegramUser() {
      if (window.Telegram && window.Telegram.WebApp) {
        return window.Telegram.WebApp.initDataUnsafe?.user;
      }
      return null;
    }

    function getReferrerId() {
      const params = new URLSearchParams(window.location.search);
      return params.get('start');
    }

    async function saveUser(user, referrerId) {
      const { error } = await supabase
        .from('users')
        .upsert({
          id: user.id,
          first_name: user.first_name,
          last_name: user.last_name,
          username: user.username,
          is_premium: user.is_premium || false,
          language_code: user.language_code,
          points: 0,
        }, { onConflict: 'id' });

      if (error) {
        console.error('Error saving user:', error);
        return;
      }

      if (referrerId && referrerId !== user.id.toString()) {
        await supabase.from('referrals').insert({
          referrer_id: parseInt(referrerId),
          referred_id: user.id,
        });

        await supabase.rpc('increment_points', { user_id: parseInt(referrerId), points: 10 });
        await supabase.rpc('increment_points', { user_id: user.id, points: 5 });
      }
    }

    async function loadPoints() {
      const user = getTelegramUser();
      if (!user) return;

      const { data, error } = await supabase
        .from('users')
        .select('points')
        .eq('id', user.id)
        .single();

      if (data) {
        document.getElementById('points').innerText = `Ù†Ù‚Ø§Ø·Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ${data.points} ğŸ‰`;
      } else {
        document.getElementById('points').innerText = 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†Ù‚Ø§Ø·Ùƒ.';
      }
    }

    function shareReferral() {
      const user = getTelegramUser();
      if (!user) return alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ.");

      const link = `https://t.me/JSjsjsksoixxjjsjsBot?start=${user.id}`;
      const text = `Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…Ù† Ø±Ø§Ø¨Ø·ÙŠ ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù…ÙƒØ§ÙØ£Ø©! ğŸ\n${link}`;

      if (window.Telegram.WebApp) {
        window.Telegram.WebApp.openTelegramLink(
          `https://t.me/share/url?url=${encodeURIComponent(text)}`
        );
      } else {
        alert("Ø§Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·:\n" + link);
      }
    }

    (async () => {
      const user = getTelegramUser();
      const referrerId = getReferrerId();
      const messageDiv = document.getElementById('message');

      if (user) {
        await saveUser(user, referrerId);

        if (referrerId) {
          messageDiv.innerHTML = `<p>ğŸ‰ Ù„Ù‚Ø¯ Ø¯Ø®Ù„Øª Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…Ù† Ø®Ù„Ø§Ù„ Ø¥Ø­Ø§Ù„Ø©! ÙˆÙ‚Ø¯ Ø­ØµÙ„Øª Ø¹Ù„Ù‰ 5 Ù†Ù‚Ø§Ø·.</p>`;
        } else {
          messageDiv.innerHTML = `<p>ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ! Ø´Ø§Ø±Ùƒ Ø±Ø§Ø¨Ø·Ùƒ Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ Ù„ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ù†Ù‚Ø§Ø·.</p>`;
        }

        loadPoints();
      } else {
        messageDiv.innerHTML = `<p>âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….</p>`;
      }
    })();
  </script>
</body>
</html>
